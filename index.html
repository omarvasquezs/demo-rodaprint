<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SISTEMA DE GUIAS</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="font-awesome/css/font-awesome.css" />
  <style>
    #pesoUnidad {
      border-top-left-radius: 1px;
      border-bottom-left-radius: 1px;
    }
  </style>
  <!-- select2 4.0.13 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- select2 bt5 theme-->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css"
    integrity="sha512-z/90a5SWiu4MWVelb5+ny7sAayYUfMmdXKEAbpj27PfdkamNdyI3hcjxPxkOPbrXoKIm7r9V2mElt5f1OtVhqA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <div class="container col-lg-6 col-md-12 my-5">
    <div class="mb-4">
      <h1 class="text-uppercase">Demo sistema de Guias</h1>
    </div>
    <!-- TABS -->
    <ul class="nav nav-tabs mb-4 px-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active text-uppercase text-center" id="informacion-tab" data-bs-toggle="tab"
          href="#informacion" role="tab" aria-controls="informacion" aria-selected="true"><i class="fa fa-wpforms"
            aria-hidden="true"></i><br>Información Básica</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link text-uppercase text-center" id="envio-tab" data-bs-toggle="tab" href="#envio" role="tab"
          aria-controls="envio" aria-selected="false"><i class="fa fa-truck" aria-hidden="true"></i><br>Datos del
          Envío</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link text-uppercase text-center" id="productos-tab" data-bs-toggle="tab" href="#productos"
          role="tab" aria-controls="productos" aria-selected="false"><i class="fa fa-shopping-basket"
            aria-hidden="true"></i><br>Productos</a>
      </li>
    </ul>
    <!-- TABS END -->
    <form method="post" onsubmit="generatePDF(event)">
      <!-- TABS CONTENT -->
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active px-4" id="informacion" role="tabpanel" aria-labelledby="informacion-tab">
          <!-- FIRST CONTENT -->
          <div class="row mb-3">
            <div class="col">
              <label for="serie" class="form-label">Serie</label>
              <select class="form-select" name="serie" id="serie">
                <option value="T001" selected>T001</option>
                <!-- Add more options here -->
              </select>
            </div>
            <div class="col">
              <label for="fechaEmision" class="form-label">Fecha de emisión</label>
              <input type="date" class="form-control" name="fechaEmision" id="fechaEmision">
            </div>
          </div>
          <div class="mb-3">
            <label for="destinatario" class="form-label">Cliente (Destinatario)*</label>
            <!-- Your select element -->
            <select name="destinatario" class="form-control select2" id="destinatario">
              <option value=""> -- SELECCIONE LA EMPRESA -- </option>
              <option value="cliente1">cliente 1</option>
              <option value="cliente2">cliente 2</option>
              <option value="cliente3">cliente 3</option>
              <!-- Add more options as needed -->
            </select>

          </div>
          <div class="row mb-3">
            <div class="col">
              <label for="destinoDireccion" class="form-label">Dirección de destino*</label>
              <select name="destinoDireccion" id="destinoDireccion" class="form-control select2">
                <option>-- SELECCIONE DIRECCIÓN --</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="observaciones" rows="3"></textarea>
          </div>
          <!-- NEXT BUTTON -->
          <button class="btn btn-primary siguiente text-uppercase">Siguiente</button>
        </div>
        <div class="tab-pane fade px-4" id="envio" role="tabpanel" aria-labelledby="envio-tab">
          <!-- SECOND CONTENT -->
          <div class="row mb-3">
            <!-- Fecha del envío -->
            <div class="col">
              <label for="fechaEnvio" class="form-label">Fecha del envío</label>
              <input type="date" class="form-control" id="fechaEnvio">
            </div>
          </div>
          <div class="row mb-5">
            <div class="col">
              <label for="cantidadBultos" class="form-label">Cantidad de bultos*</label>
              <input type="number" class="form-control" id="cantidadBultos">
            </div>
            <div class="col">
              <label for="pesoTotal" class="form-label">Peso total*</label>
              <div class="input-group">
                <input type="number" class="form-control" name="pesoTotal" id="pesoTotal">
                <div class="input-group-append">
                  <select class="form-select" id="pesoUnidad">
                    <option value="kg" selected>KG</option>
                    <option value="t">T</option>
                    <option value="oz">OZ</option>
                    <option value="lb">LB</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <!-- BACK/NEXT BUTTONS -->
          <button id="btn_anterior_1" name="btn_anterior_1" class="btn btn-secondary text-uppercase">anterior</button>
          <button class="btn btn-primary siguiente text-uppercase">Siguiente</button>
        </div>
        <div class="tab-pane fade px-4" id="productos" role="tabpanel" aria-labelledby="productos-tab">
          <!-- THIRD CONTENT -->
          <div class="row mb-2">
            <div class="col-md-8 mb-4">
              <select id="seleccionarProducto" class="form-control select2">
                <option value=""> -- SELECCIONE PRODUCTO -- </option>
                <option value="producto_1">Producto 1</option>
                <option value="producto_2">Producto 2</option>
                <option value="producto_3">Producto 3</option>
              </select>
            </div>
            <div class="col-md-4">
              <a id="agregarProducto" class="btn btn-success btn-block text-uppercase w-100"><i
                  class="fa fa-plus-circle" aria-hidden="true"></i> AÑADIR
              </a>
            </div>
          </div>
          <div class="row mb-5">
            <div class="col">
              <table id="productTable" class="table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Acción</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Table rows will be added here -->
                </tbody>
              </table>
            </div>
          </div>
          <!-- BACK/SUBMIT BUTTONS -->
          <button id="btn_anterior_2" name="btn_anterior_2" class="btn btn-secondary text-uppercase">anterior</button>
          <button type="submit" class="btn btn-primary text-uppercase">Procesar</button>
        </div>
      </div>
    </form>
  </div>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <!-- Bootstrap JS y dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- select2@4.0.13 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      // Array of all tab-ids
      var tabs = ['informacion', 'envio', 'productos'];

      // Add click event listener to all 'Siguiente' buttons
      $('.siguiente').click(function (e) {
        e.preventDefault();

        // Find the current active tab
        var activeTab = $('.nav-link.active').attr('id').split('-')[0];

        // Find the index of the next tab
        var nextTabIndex = tabs.indexOf(activeTab) + 1;

        // If there is a next tab
        if (nextTabIndex < tabs.length) {
          // Remove 'active' class from current tab and pane
          $('#' + activeTab + '-tab').removeClass('active');
          $('#' + activeTab).removeClass('show active');

          // Add 'active' class to next tab and pane
          $('#' + tabs[nextTabIndex] + '-tab').addClass('active');
          $('#' + tabs[nextTabIndex]).addClass('show active');
        }
      });

      // Add click event listener to 'btn_anterior_1'
      $('#btn_anterior_1').click(function (e) {
        e.preventDefault();

        // Remove 'active' class from current tab and pane
        var activeTab = $('.nav-link.active').attr('id').split('-')[0];
        $('#' + activeTab + '-tab').removeClass('active');
        $('#' + activeTab).removeClass('show active');

        // Add 'active' class to first tab and pane
        $('#informacion-tab').addClass('active');
        $('#informacion').addClass('show active');
      });

      // Add click event listener to 'btn_anterior_2'
      $('#btn_anterior_2').click(function (e) {
        e.preventDefault();

        // Remove 'active' class from current tab and pane
        var activeTab = $('.nav-link.active').attr('id').split('-')[0];
        $('#' + activeTab + '-tab').removeClass('active');
        $('#' + activeTab).removeClass('show active');

        // Add 'active' class to second tab and pane
        $('#envio-tab').addClass('active');
        $('#envio').addClass('show active');
      });
    });

    var Select2Cascade = (function (window, $) {

      function Select2Cascade(parent, child, url, select2Options) {
        var afterActions = [];
        var options = select2Options || {};

        // Register functions to be called after cascading data loading done
        this.then = function (callback) {
          afterActions.push(callback);
          return this;
        };

        parent.select2(select2Options).on("change", function (e) {

          child.prop("disabled", true);

          var _this = this;
          $.getJSON(url.replace(':parentId:', $(this).val()), function (items) {
            var newOptions = '<option value="">-- Seleccione Dirección --</option>';
            for (var id in items) {
              newOptions += '<option value="' + id + '">' + items[id] + '</option>';
            }

            child.select2('destroy').html(newOptions).prop("disabled", false)
              .select2(options);

            afterActions.forEach(function (callback) {
              callback(parent, child, items);
            });
          });
        });
      }

      return Select2Cascade;

    })(window, $);

    $(document).ready(function () {
      var select2Options = { width: 'resolve', theme: 'bootstrap-5' };

      var apiUrl = ':parentId:.json';

      $('#destinatario').select2(select2Options);
      $('#destinoDireccion').select2(select2Options);
      $('#seleccionarProducto').select2(select2Options);
      var cascadLoading = new Select2Cascade($('#destinatario'), $('#destinoDireccion'), apiUrl, select2Options);
      cascadLoading.then(function (parent, child, items) {
        // Dump response data
        console.log(items);
      });
    });
  </script>
  <script>
    document.getElementById('agregarProducto').addEventListener('click', function () {
      // Get the selected product
      var selectedProduct = document.getElementById('seleccionarProducto').value;

      // Check if the selected product has a value
      if (selectedProduct != '') {
        // Create a new row
        var newRow = document.createElement('tr');

        // Create a cell for the product
        var productCell = document.createElement('td');
        productCell.textContent = selectedProduct;
        productCell.style.minWidth = '12rem'; // Set the minimum width of the cell
        newRow.appendChild(productCell);


        // Create a cell with an input for the quantity
        var quantityCell = document.createElement('td');
        var quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = '1'; // Default quantity
        quantityInput.className = 'form-control'; // Add the form-control class
        quantityInput.style.width = '5rem'; // Set the width of the input
        quantityCell.appendChild(quantityInput);
        newRow.appendChild(quantityCell);

        // Create a cell with a remove button
        var actionCell = document.createElement('td');
        var removeButton = document.createElement('button');
        removeButton.innerHTML = '<i class="fa fa-trash-o"></i>'; // Use innerHTML instead of textContent
        removeButton.className = 'btn btn-danger'; // Add classes to the button
        removeButton.onclick = function () {
          // Remove the current row
          this.closest('tr').remove();
        };
        actionCell.appendChild(removeButton);
        newRow.appendChild(actionCell);

        // Add the new row to the table
        document.getElementById('productTable').querySelector('tbody').appendChild(newRow);
      }
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    function generatePDF(event) {
      event.preventDefault(); // Prevent the default form submission

      // Collect form data
      const formData = new FormData(event.target);
      const destinatario = formData.get('destinatario');
      const destinoDireccion = formData.get('destinoDireccion');
      const fechaEmision = formData.get('fechaEmision');
      // Collect other form data as needed

      // Load the template.html file
      fetch('template.html')
        .then(response => response.text())
        .then(templateHtml => {
          // Modify the template with the collected form data
          const modifiedTemplate = templateHtml.replace('{{destinatario}}', destinatario)
            .replace('{{destinoDireccion}}', destinoDireccion)
            .replace('{{fechaEmision}}', fechaEmision);
          // Create a new HTML element to hold the modified template
          const templateElement = document.createElement('div');
          templateElement.innerHTML = modifiedTemplate;
          document.body.appendChild(templateElement);

          // Convert the HTML content to a PDF using html2canvas and jsPDF
          html2canvas(templateElement).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('guia_remision.pdf');

            // Remove the temporary template element
            document.body.removeChild(templateElement);
          });
        })
        .catch(error => console.error('Error:', error));
    }
  </script>
</body>

</html>